@model lms_test1.Models.DTO.Advisory.SectionWithStudentsWithScoresDTO

@{
    ViewData["Title"] = Model.Section.Name;
    int subjectCount = Model.Section.TeacherSubjectSections?.Select(tss => tss.TeacherSubject.Subject).Distinct().Count() ??
    0;
    subjectCount += 3;
}

<header>
    <div class="breadcrumbs mx-auto">
        <a asp-controller="Advisory" asp-action="Index">Advisories</a> >
        <span>@ViewData["Title"]</span>
    </div>

    <h2 class="title">@ViewData["Title"]</h2>
</header>

<form class="pure-form" style="position: relative; display: inline-block; margin: .5rem 2rem;">
    <svg style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; pointer-events: none; color: #888;"
        xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 24 24" fill="currentColor">
        <path
            d="M15.5 14h-.79l-.28-.27a6.471 6.471 0 001.48-5.34C15.02 5.59 12.43 3 9.5 3S4 5.59 4 8.5 6.59 14 9.5 14c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
    </svg>

    <input id="searchBox" type="text" placeholder="Search..."
        style="padding-left: 36px; font-size: 1rem; border: 1px solid #ccc; border-radius: 4px;" />

</form>
<div class="prevent-overflow px-8">
    <table class="pure-table">
        <thead>
            <tr>
                <th>Student</th>
                @if (Model.Section.TeacherSubjectSections!.Any())
                {
                    foreach (var subject in Model.Section.TeacherSubjectSections!.Select(tss =>
                    tss.TeacherSubject.Subject).Distinct())
                    {
                        <th style="text-align: center;">@subject.Name</th>
                    }
                }
            </tr>
        </thead>
        <tbody id="studentTableBody">
            @if (Model.Students == null || !Model.Students.Any())
            {
                <tr>
                    <td colspan="@subjectCount" style="text-align: center; font-style: italic; color: #888;">
                        No students found.
                    </td>
                </tr>
            }
            else
            {
                if (Model.Students.Where(s => s.Gender == 'M').ToList().Count() > 0)
                {
                    <tr style="border-bottom: 1px solid #888;">
                        <td>Male</td>
                    </tr>
                }
                foreach (var student in Model.Students.Where(s => s.Gender == 'M'))
                {
                    <tr>
                        <td>@Html.DisplayFor(m => student.FirstName), @Html.DisplayFor(m => student.LastName), @Html.DisplayFor(m => student.MiddleName[0]).</td>
                        @if (Model.Section.TeacherSubjectSections!.Any())
                        {
                            foreach (var subject in Model.Section.TeacherSubjectSections!.Select(tss =>
                            tss.TeacherSubject.Subject).Distinct())
                            {
                                <td style="text-align: center;">
                                    @{
                                        var score = student.Scores?.FirstOrDefault(sc => sc.TeacherSubject.SubjectId == subject.Id);
                                        if (score != null)
                                        {
                                            @score.FinalGrade_First
                                        }
                                        else
                                        {
                                            @Html.Raw("<span style='color: #888; font-style: italic;'>N/A</span>")
                                        }
                                    }
                                </td>
                            }
                        }
                    </tr>
                }
                if (Model.Students.Where(s => s.Gender == 'F').ToList().Count() > 0)
                {
                    <tr style="border-bottom: 1px solid #888; border-top: 1px solid #888;">
                        <td>Female</td>
                    </tr>
                }
                foreach (var student in Model.Students.Where(s => s.Gender == 'F'))
                {
                    <tr>
                        <td>@Html.DisplayFor(m => student.FirstName), @Html.DisplayFor(m => student.LastName), @Html.DisplayFor(m => student.MiddleName[0]).</td>
                        @if (Model.Section.TeacherSubjectSections!.Any())
                        {
                            foreach (var subject in Model.Section.TeacherSubjectSections!.Select(tss =>
                            tss.TeacherSubject.Subject).Distinct())
                            {
                                <td style="text-align: center;">
                                    @{
                                        var score = student.Scores?.FirstOrDefault(sc => sc.TeacherSubject.SubjectId == subject.Id);
                                        if (score != null)
                                        {
                                            @score.FinalGrade_First
                                        }
                                        else
                                        {
                                            @Html.Raw("<span style='color: #888; font-style: italic;'>N/A</span>")
                                        }
                                    }
                                </td>
                            }
                        }
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        $(function () {
            $("#searchBox").on("keyup", function () {
                var query = $(this).val();

                $.get('@Url.Action("SearchStudent", "Advisory")', { searchTerm: query, sectionId: '@Model.Section.Id' }, function (data) {
                    $("#studentTableBody").html(data);
                });
            });
        });
    </script>
}